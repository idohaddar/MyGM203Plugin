exports.name = "GM-203 Virtual RGB Device Advanced";
exports.author = "YourName";
exports.version = "1.0.0";

exports.device = {
  leds: 30,
  layout: "linear",
  description: "Virtual RGB device mimicking GM-203 LED strip synced with motherboard LEDs"
};

let brightness = 1.0; // brightness user setting

// Called on plugin initialization
exports.init = async function () {
  console.log("GM-203 advanced plugin initializing");
  this.brightness = brightness;
};

// Called when user changes settings
exports.userControl = function (device, type, value) {
  if (type === "brightness") {
    this.brightness = value;
    console.log("Brightness set to", value);
  }
};

// Function to apply brightness to color array
function applyBrightness(rgbArray, brightness) {
  return rgbArray.map(c => Math.min(255, Math.max(0, Math.round(c * brightness))));
}

// Called every frame to update LEDs colors
exports.update = function (device, colors) {
  for (let i = 0; i < this.device.leds; i++) {
    // Apply brightness and set color; fallback to black
    const color = colors[i] ? applyBrightness(colors[i], this.brightness) : [0, 0, 0];
    device.setColor(i, color);
  }
};

// Called when device connects
exports.onConnect = function () {
  console.log("GM-203 virtual device connected");
};

// Called when device disconnects
exports.onDisconnect = function () {
  console.log("GM-203 virtual device disconnected");
};
